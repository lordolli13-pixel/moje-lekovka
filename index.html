<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Moje Lékovka</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; padding: 10px; }
        .sekce { background-color: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; margin-bottom: 20px; }
        .policko { background: #0f172a; border: 1px solid #475569; width: 100%; padding: 12px; border-radius: 8px; color: white; margin-bottom: 10px; outline: none; }
        .label { display: block; font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .lek-karta { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 15px; margin-bottom: 12px; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .critical-border { border-left: 5px solid #ef4444; }
        .normal-border { border-left: 5px solid #f59e0b; }
        .btn-take { background: #f59e0b; color: #0f172a; font-weight: 900; border-radius: 10px; padding: 12px; width: 100%; border: none; cursor: pointer; text-transform: uppercase; font-size: 13px; margin-top: 10px; }
        .btn-bulk { background: #10b981; color: #0f172a; font-weight: 900; border-radius: 8px; padding: 6px 12px; border: none; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .vzano { opacity: 0.4; filter: grayscale(0.5); transform: scale(0.98); }
        .badge-info { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #cbd5e1; }
        .tab-btn { padding: 12px; flex: 1; text-align: center; font-weight: bold; font-size: 11px; color: #64748b; }
        .tab-active { color: #f59e0b; border-bottom: 3px solid #f59e0b; background: rgba(245, 158, 11, 0.05); }
        .chip { padding: 8px; border-radius: 8px; background: #334155; font-size: 11px; cursor: pointer; text-align: center; border: 2px solid transparent; }
        .chip-active { border-color: #f59e0b; color: #f59e0b; }
        .hist-den { border-bottom: 1px solid #334155; padding: 10px 0; }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto">
        <div class="flex mb-6 bg-slate-900 rounded-xl p-1 border border-slate-800 sticky top-0 z-50">
            <button onclick="nav('today')" id="t-today" class="tab-btn tab-active">DNES</button>
            <button onclick="nav('list')" id="t-list" class="tab-btn">LÉKÁRNA</button>
            <button onclick="nav('hist')" id="t-hist" class="tab-btn">HISTORIE</button>
            <button onclick="nav('add')" id="t-add" class="tab-btn">+ PŘIDAT</button>
        </div>

        <div id="p-today">
            <h2 id="today-date" class="text-center text-amber-500 font-black mb-4 uppercase tracking-tighter"></h2>
            <div id="seznam-dnes" class="space-y-4"></div>
        </div>

        <div id="p-list" class="hidden">
            <div class="sekce border-amber-500/30">
                <h2 class="text-[10px] font-bold text-amber-500 mb-3 uppercase tracking-widest">Upozornění a Systém</h2>
                <div class="grid grid-cols-2 gap-2">
                    <button id="btn-notif-master" onclick="requestNotif()" class="bg-slate-700 p-3 rounded-lg text-[10px] font-bold uppercase flex flex-col items-center gap-1 transition-all duration-300">
                        <span id="icon-notif" class="iconify text-lg" data-icon="lucide:bell"></span> 
                        <span id="text-notif">Zapnout</span>
                    </button>
                    <button onclick="testNotif()" class="bg-slate-700 active:bg-amber-600 p-3 rounded-lg text-[10px] font-bold uppercase flex flex-col items-center gap-1 transition-all">
                        <span class="iconify text-lg" data-icon="lucide:test-tube"></span> Test
                    </button>
                </div>
                <div id="notif-status" class="text-[9px] text-center mt-2 text-slate-500 italic">Zjišťuji stav systému...</div>
            </div>
            <div id="seznam-vse" class="space-y-4"></div>
        </div>

        <div id="p-hist" class="hidden">
            <div class="sekce">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-amber-500 uppercase">Historie užívání</h2>
                    <button onclick="promazatHistorii()" class="text-[9px] bg-red-500/20 text-red-400 px-2 py-1 rounded">Smazat vše</button>
                </div>
                <div id="seznam-historie" class="space-y-2"></div>
            </div>
        </div>

        <div id="p-add" class="hidden">
            <div class="sekce">
                <h2 id="edit-title" class="text-xs font-bold text-amber-500 mb-4 uppercase text-center">Nový lék</h2>
                <input type="hidden" id="f-id">
                
                <label class="label">Ikona</label>
                <div class="grid grid-cols-5 gap-2 mb-4">
                    <div class="chip i-chip chip-active" onclick="setI(this, 'pill')"><span class="iconify text-2xl" data-icon="lucide:pill"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'syringe')"><span class="iconify text-2xl" data-icon="lucide:syringe"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'droplets')"><span class="iconify text-2xl" data-icon="lucide:droplets"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'beaker')"><span class="iconify text-2xl" data-icon="lucide:beaker"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'spray-can')"><span class="iconify text-2xl" data-icon="lucide:spray-can"></span></div>
                </div>

                <label class="label">Název léku</label>
                <input id="f-nazev" type="text" class="policko font-bold text-lg" placeholder="Zadejte název">

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="label">Skladem (ks)</label><input id="f-sklad" type="number" step="0.25" class="policko" value="0"></div>
                    <div><label class="label">Dávka (ks)</label><input id="f-davka" type="number" step="0.25" class="policko" value="1"></div>
                </div>

                <label class="label">Časy (např. 08:00)</label>
                <div class="flex gap-2 mb-2">
                    <input id="f-cas" type="time" class="policko">
                    <button onclick="addT()" class="bg-slate-700 px-4 mb-[10px] rounded-lg font-bold">+</button>
                </div>
                <div id="f-seznam-casu" class="flex flex-wrap gap-2 mb-4"></div>

                <label class="label">Opakování (Dny)</label>
                <div class="grid grid-cols-7 gap-1 mb-4">
                    <div class="chip d-chip" onclick="toggleD(this)">Po</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Út</div>
                    <div class="chip d-chip" onclick="toggleD(this)">St</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Čt</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Pá</div>
                    <div class="chip d-chip" onclick="toggleD(this)">So</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Ne</div>
                </div>

                <label class="label">Speciální režim</label>
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div class="chip r-chip border-dashed border-amber-500/50" onclick="toggleR(this)" data-val="liche">OBDEN LICHÉ</div>
                    <div class="chip r-chip border-dashed border-amber-500/50" onclick="toggleR(this)" data-val="sude">OBDEN SUDÉ</div>
                </div>

                <button id="btn-save" onclick="ulozit()" class="btn-take">Uložit lék</button>
                <button id="btn-cancel" onclick="resetForm(); nav('list');" class="hidden w-full text-slate-500 text-[10px] uppercase font-bold mt-4">Zrušit editaci</button>
            </div>
        </div>
    </div>

    <script>
        let leky = JSON.parse(localStorage.getItem('Lekovka_V6')) || [];
        let vzato = JSON.parse(localStorage.getItem('Lekovka_Vzato_V6')) || {};
        let historie = JSON.parse(localStorage.getItem('Lekovka_Hist_V6')) || [];
        let lastCheck = localStorage.getItem('Lekovka_LastDate_V6');
        let tmpIkona = 'pill';
        let tmpCasy = [];

        const todayKey = new Date().toLocaleDateString();
        if (lastCheck && lastCheck !== todayKey) {
            vzato = {}; 
            localStorage.setItem('Lekovka_Vzato_V6', JSON.stringify(vzato));
        }
        localStorage.setItem('Lekovka_LastDate_V6', todayKey);

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                console.log('SW registrován');
                navigator.serviceWorker.ready.then(() => synchronizovatSW());
            });
        }

        async function synchronizovatSW() {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'UPDATE_MEDS',
                    leky: leky
                });
            }
        }

        // --- NOTIFIKACE ---
        function updateNotifUI() {
            const statusEl = document.getElementById('notif-status');
            const btn = document.getElementById('btn-notif-master');
            if (Notification.permission === 'granted') {
                statusEl.innerText = "✓ Notifikace aktivní";
                statusEl.className = "text-[9px] text-center mt-2 text-emerald-500 font-bold uppercase";
                btn.className = "bg-emerald-600 p-3 rounded-lg text-[10px] font-bold uppercase flex flex-col items-center gap-1";
            } else if (Notification.permission === 'denied') {
                statusEl.innerText = "✕ Notifikace blokovány v systému";
                statusEl.className = "text-[9px] text-center mt-2 text-red-500 font-bold";
            }
        }

        function requestNotif() {
            Notification.requestPermission().then(perm => {
                updateNotifUI();
                if (perm === 'granted') {
                    testNotif();
                    synchronizovatSW();
                }
            });
        }

        function testNotif() {
            if (Notification.permission === "granted") {
                navigator.serviceWorker.ready.then(reg => {
                    reg.showNotification("Lékovka", {
                        body: "Testovací upozornění - funguje to!",
                        vibrate: [200, 100, 200]
                    });
                });
            } else {
                alert("Povolte notifikace tlačítkem ZAPNOUT. Stav: " + Notification.permission);
            }
        }

        // --- NAVIGACE ---
        function nav(p) {
            document.querySelectorAll('[id^="p-"]').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('p-' + p).classList.remove('hidden');
            document.getElementById('t-' + p).classList.add('tab-active');
            if(p === 'today' || p === 'list') vykreslit();
            if(p === 'hist') vykreslitHistorii();
        }

        // --- LOGIKA LÉKŮ ---
        function potvrdit(id, cas) {
            let k = id + "_" + cas;
            if (vzato[k]) return;
            let l = leky.find(x => x.id === id);
            l.sklad = Math.max(0, Math.round((l.sklad - l.davka) * 100) / 100);
            vzato[k] = true;
            localStorage.setItem('Lekovka_V6', JSON.stringify(leky));
            localStorage.setItem('Lekovka_Vzato_V6', JSON.stringify(vzato));
            aktualizovatHistorii(); vykreslit();
        }

        function potvrditVseVCase(cas, ids) {
            ids.forEach(id => potvrdit(id, cas));
        }

        function aktualizovatHistorii() {
            const n = new Date();
            const dJmeno = ["Ne", "Po", "Út", "St", "Čt", "Pá", "So"][n.getDay()];
            const dCislo = n.getDate();
            let dnesniZaznamy = [];
            leky.forEach(l => {
                let ok = (!l.rezim && (l.dny.length === 0 || l.dny.includes(dJmeno))) || 
                         (l.rezim === 'liche' && dCislo % 2 !== 0) || (l.rezim === 'sude' && dCislo % 2 === 0);
                if (ok) l.casy.forEach(c => { dnesniZaznamy.push({ nazev: l.nazev, cas: c, vzano: vzato[l.id + "_" + c] || false }); });
            });
            dnesniZaznamy.sort((a, b) => a.cas.localeCompare(b.cas));
            let idx = historie.findIndex(h => h.datum === todayKey);
            if (idx !== -1) historie[idx].data = dnesniZaznamy; else historie.unshift({ datum: todayKey, data: dnesniZaznamy });
            if(historie.length > 7) historie.pop();
            localStorage.setItem('Lekovka_Hist_V6', JSON.stringify(historie));
        }

        function vykreslitHistorii() {
            aktualizovatHistorii();
            let html = historie.map(h => `
                <div class="hist-den ${h.datum === todayKey ? 'border-l-2 border-amber-500 pl-3' : 'opacity-60'}">
                    <div class="text-[10px] font-bold uppercase mb-2 ${h.datum === todayKey ? 'text-amber-500' : 'text-slate-500'}">${h.datum}</div>
                    ${h.data.map(d => `
                        <div class="flex justify-between items-center text-xs mb-1">
                            <span>${d.cas} - ${d.nazev}</span>
                            <span class="iconify ${d.vzano ? 'text-emerald-500' : 'text-red-500'}" data-icon="${d.vzano ? 'lucide:check-circle' : 'lucide:x-circle'}"></span>
                        </div>`).join('')}
                </div>`).join('');
            document.getElementById('seznam-historie').innerHTML = html || '<div class="text-center opacity-30 py-10 italic">Prázdno</div>';
        }

        function setI(el, val) { document.querySelectorAll('.i-chip').forEach(c => c.classList.remove('chip-active')); el.classList.add('chip-active'); tmpIkona = val; }
        function addT() { let v = document.getElementById('f-cas').value; if(v && !tmpCasy.includes(v)) { tmpCasy.push(v); tmpCasy.sort(); renderTmpT(); } }
        function renderTmpT() { document.getElementById('f-seznam-casu').innerHTML = tmpCasy.map(t => `<span onclick="removeT('${t}')" class="bg-amber-500/20 text-amber-500 px-2 py-1 rounded text-[10px] font-bold cursor-pointer">${t} ×</span>`).join(' '); }
        function removeT(t) { tmpCasy = tmpCasy.filter(x => x !== t); renderTmpT(); }
        function toggleD(el) { document.querySelectorAll('.r-chip').forEach(r => r.classList.remove('chip-active')); el.classList.toggle('chip-active'); }
        function toggleR(el) { let uz = el.classList.contains('chip-active'); document.querySelectorAll('.d-chip, .r-chip').forEach(c => c.classList.remove('chip-active')); if(!uz) el.classList.add('chip-active'); }

        function resetForm() { 
            document.getElementById('f-id').value = ''; document.getElementById('f-nazev').value = ''; 
            document.getElementById('f-sklad').value = '0'; document.getElementById('f-davka').value = '1'; 
            tmpCasy = []; renderTmpT(); 
            document.querySelectorAll('.chip-active').forEach(c => c.classList.remove('chip-active'));
        }

        function ulozit() { 
            let n = document.getElementById('f-nazev').value; let editId = document.getElementById('f-id').value; 
            if(!n || tmpCasy.length === 0) return alert("Název a čas!"); 
            let data = { 
                id: editId ? parseInt(editId) : Date.now(), ikona: tmpIkona, nazev: n, 
                sklad: parseFloat(document.getElementById('f-sklad').value) || 0, 
                davka: parseFloat(document.getElementById('f-davka').value) || 1, 
                casy: [...tmpCasy], dny: Array.from(document.querySelectorAll('.d-chip.chip-active')).map(d => d.innerText), 
                rezim: document.querySelector('.r-chip.chip-active')?.dataset.val || '' 
            }; 
            if(editId) { let idx = leky.findIndex(x => x.id === parseInt(editId)); leky[idx] = data; } else { leky.push(data); } 
            localStorage.setItem('Lekovka_V6', JSON.stringify(leky)); 
            synchronizovatSW(); resetForm(); nav('list'); 
        }

        function buildCard(l, casDnes = null) { 
            let jeVzato = casDnes ? vzato[l.id + "_" + casDnes] : false; 
            return `
                <div class="lek-karta ${l.sklad <= 2 ? 'critical-border' : 'normal-border'} ${jeVzato ? 'vzano' : ''}">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="iconify text-3xl text-amber-500" data-icon="lucide:${l.ikona}"></span>
                            <div>
                                <div class="font-bold text-lg">${l.nazev}</div>
                                <div class="text-[10px] text-slate-400 uppercase">Skladem: ${l.sklad} | Dávka: ${l.davka}</div>
                            </div>
                        </div>
                        ${!casDnes ? `<button onclick="smazat(${l.id})" class="text-red-500/20"><span class="iconify text-xl" data-icon="lucide:trash-2"></span></button>` : ''}
                    </div>
                    ${casDnes && !jeVzato ? `<button onclick="potvrdit(${l.id},'${casDnes}')" class="btn-take">Potvrdit ${casDnes}</button>` : (jeVzato ? '<div class="text-center text-xs text-emerald-500 font-bold mt-2">VZATO ✓</div>' : '')}
                </div>`; 
        }

        function smazat(id) { if(confirm("Smazat?")) { leky = leky.filter(l => l.id !== id); localStorage.setItem('Lekovka_V6', JSON.stringify(leky)); synchronizovatSW(); vykreslit(); } }

        function vykreslit() { 
            const n = new Date(); const dJmeno = ["Ne", "Po", "Út", "St", "Čt", "Pá", "So"][n.getDay()]; const dCislo = n.getDate();
            document.getElementById('today-date').innerText = dJmeno + " " + n.toLocaleDateString(); 
            document.getElementById('seznam-vse').innerHTML = leky.map(l => buildCard(l)).join('') || '<div class="text-center opacity-20 py-10">Žádné léky</div>'; 
            let groups = {}; 
            leky.forEach(l => { 
                let ok = (!l.rezim && (l.dny.length === 0 || l.dny.includes(dJmeno))) || (l.rezim === 'liche' && dCislo % 2 !== 0) || (l.rezim === 'sude' && dCislo % 2 === 0); 
                if(ok) l.casy.forEach(c => { if(!groups[c]) groups[c] = []; groups[c].push(l); }); 
            }); 
            let dnesHtml = ""; 
            Object.keys(groups).sort().forEach(cas => { 
                let ids = groups[cas].filter(l => !vzato[l.id + "_" + cas]).map(l => l.id);
                dnesHtml += `<div class="mb-6"><div class="flex justify-between border-b border-slate-700 pb-1 mb-2"><h3 class="font-black text-amber-500">${cas}</h3>${ids.length > 0 ? `<button onclick="potvrditVseVCase('${cas}',[${ids.join(',')}])" class="btn-bulk">Vše</button>` : ''}</div>
                ${groups[cas].map(l => buildCard(l, cas)).join('')}</div>`; 
            }); 
            document.getElementById('seznam-dnes').innerHTML = dnesHtml || '<div class="text-center opacity-20 py-10">Dnes volno</div>'; 
        }

        window.addEventListener('load', updateNotifUI);
        vykreslit();
    </script>
</body>
</html>
