<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Moje Lékovka</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; padding: 10px; -webkit-tap-highlight-color: transparent; }
        .sekce { background-color: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; margin-bottom: 20px; }
        .policko { background: #0f172a; border: 1px solid #475569; width: 100%; padding: 12px; border-radius: 8px; color: white; margin-bottom: 10px; outline: none; }
        .label { display: block; font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .lek-karta { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 15px; margin-bottom: 12px; position: relative; overflow: hidden; transition: all 0.3s ease; }
        .critical-border { border-left: 5px solid #ef4444; }
        .normal-border { border-left: 5px solid #f59e0b; }
        .btn-take { background: #f59e0b; color: #0f172a; font-weight: 900; border-radius: 10px; padding: 12px; width: 100%; border: none; cursor: pointer; text-transform: uppercase; font-size: 13px; margin-top: 10px; }
        .btn-bulk { background: #10b981; color: #0f172a; font-weight: 900; border-radius: 8px; padding: 6px 12px; border: none; cursor: pointer; text-transform: uppercase; font-size: 10px; }
        .vzano { opacity: 0.4; filter: grayscale(0.5); transform: scale(0.98); }
        .badge-info { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 10px; color: #cbd5e1; }
        .tab-btn { padding: 12px; flex: 1; text-align: center; font-weight: bold; font-size: 11px; color: #64748b; }
        .tab-active { color: #f59e0b; border-bottom: 3px solid #f59e0b; background: rgba(245, 158, 11, 0.05); }
        .chip { padding: 8px; border-radius: 8px; background: #334155; font-size: 11px; cursor: pointer; text-align: center; border: 2px solid transparent; }
        .chip-active { border-color: #f59e0b; color: #f59e0b; }
        .hist-den { border-bottom: 1px solid #334155; padding: 10px 0; }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto">
        <div class="flex mb-6 bg-slate-900 rounded-xl p-1 border border-slate-800 sticky top-0 z-50">
            <button onclick="nav('today')" id="t-today" class="tab-btn tab-active">DNES</button>
            <button onclick="nav('list')" id="t-list" class="tab-btn">LÉKÁRNA</button>
            <button onclick="nav('hist')" id="t-hist" class="tab-btn">HISTORIE</button>
            <button onclick="nav('add')" id="t-add" class="tab-btn">+ PŘIDAT</button>
        </div>

        <div id="p-today">
            <h2 id="today-date" class="text-center text-amber-500 font-black mb-4 uppercase tracking-tighter"></h2>
            <div id="seznam-dnes" class="space-y-4"></div>
        </div>

        <div id="p-list" class="hidden">
            <div id="seznam-vse" class="space-y-4"></div>
            <div class="mt-8 flex flex-col gap-4 items-center">
                <button onclick="exportToICS()" class="text-[11px] bg-amber-500/10 text-amber-500 border border-amber-500/20 px-4 py-2 rounded-lg font-bold uppercase tracking-widest w-full">Export do kalendáře (.ics)</button>
                <button onclick="exportDat()" class="text-[10px] text-slate-500 underline uppercase tracking-widest">Zálohovat data do konzole</button>
            </div>
        </div>

        <div id="p-hist" class="hidden">
            <div class="sekce">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xs font-bold text-amber-500 uppercase">Historie užívání</h2>
                    <button onclick="promazatHistorii()" class="text-[9px] bg-red-500/20 text-red-400 px-2 py-1 rounded">Smazat vše</button>
                </div>
                <div id="seznam-historie" class="space-y-2"></div>
            </div>
        </div>

        <div id="p-add" class="hidden">
            <div class="sekce">
                <h2 id="edit-title" class="text-xs font-bold text-amber-500 mb-4 uppercase text-center">Nový lék</h2>
                <input type="hidden" id="f-id">
                
                <label class="label">Ikona</label>
                <div class="grid grid-cols-5 gap-2 mb-4">
                    <div class="chip i-chip chip-active" onclick="setI(this, 'pill')"><span class="iconify text-2xl" data-icon="lucide:pill"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'syringe')"><span class="iconify text-2xl" data-icon="lucide:syringe"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'droplets')"><span class="iconify text-2xl" data-icon="lucide:droplets"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'beaker')"><span class="iconify text-2xl" data-icon="lucide:beaker"></span></div>
                    <div class="chip i-chip" onclick="setI(this, 'spray-can')"><span class="iconify text-2xl" data-icon="lucide:spray-can"></span></div>
                </div>

                <label class="label">Název léku</label>
                <input id="f-nazev" type="text" class="policko font-bold text-lg" placeholder="Zadejte název">

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div><label class="label">Skladem (ks)</label><input id="f-sklad" type="number" step="0.25" class="policko" value="0"></div>
                    <div><label class="label">Dávka (ks)</label><input id="f-davka" type="number" step="0.25" class="policko" value="1"></div>
                </div>

                <label class="label">Časy (např. 08:00)</label>
                <div class="flex gap-2 mb-2">
                    <input id="f-cas" type="time" class="policko">
                    <button onclick="addT()" class="bg-slate-700 px-4 mb-[10px] rounded-lg font-bold">+</button>
                </div>
                <div id="f-seznam-casu" class="flex flex-wrap gap-2 mb-4"></div>

                <label class="label">Opakování (Dny)</label>
                <div class="grid grid-cols-7 gap-1 mb-4">
                    <div class="chip d-chip" onclick="toggleD(this)">Po</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Út</div>
                    <div class="chip d-chip" onclick="toggleD(this)">St</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Čt</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Pá</div>
                    <div class="chip d-chip" onclick="toggleD(this)">So</div>
                    <div class="chip d-chip" onclick="toggleD(this)">Ne</div>
                </div>

                <label class="label">Speciální režim</label>
                <div class="grid grid-cols-2 gap-2 mb-6">
                    <div class="chip r-chip border-dashed border-amber-500/50" onclick="toggleR(this)" data-val="liche">OBDEN LICHÉ</div>
                    <div class="chip r-chip border-dashed border-amber-500/50" onclick="toggleR(this)" data-val="sude">OBDEN SUDÉ</div>
                </div>

                <button id="btn-save" onclick="ulozit()" class="btn-take">Uložit lék</button>
                <button id="btn-cancel" onclick="resetForm(); nav('list');" class="hidden w-full text-slate-500 text-[10px] uppercase font-bold mt-4">Zrušit editaci</button>
            </div>
        </div>
    </div>

    <script>
        let leky = JSON.parse(localStorage.getItem('Lekovka_V6')) || [];
        let vzato = JSON.parse(localStorage.getItem('Lekovka_Vzato_V6')) || {};
        let historie = JSON.parse(localStorage.getItem('Lekovka_Hist_V6')) || [];
        let lastCheck = localStorage.getItem('Lekovka_LastDate_V6');
        let tmpIkona = 'pill';
        let tmpCasy = [];

        const todayKey = new Date().toLocaleDateString();

        if (lastCheck && lastCheck !== todayKey) {
            vzato = {}; 
            localStorage.setItem('Lekovka_Vzato_V6', JSON.stringify(vzato));
        }
        localStorage.setItem('Lekovka_LastDate_V6', todayKey);

        function nav(p) {
            document.querySelectorAll('[id^="p-"]').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('p-' + p).classList.remove('hidden');
            document.getElementById('t-' + p).classList.add('tab-active');
            if(p === 'today' || p === 'list') vykreslit();
            if(p === 'hist') vykreslitHistorii();
            window.scrollTo(0,0);
        }

        function potvrdit(id, cas) {
            let k = id + "_" + cas;
            if (vzato[k]) return;
            let l = leky.find(x => x.id === id);
            if (!l) return;
            if (l.sklad < l.davka) { if(!confirm("Nedostatek skladem. Potvrdit?")) return; }
            l.sklad = Math.round((l.sklad - l.davka) * 100) / 100;
            if(l.sklad < 0) l.sklad = 0;
            vzato[k] = true;
            localStorage.setItem('Lekovka_V6', JSON.stringify(leky));
            localStorage.setItem('Lekovka_Vzato_V6', JSON.stringify(vzato));
            aktualizovatHistorii(); 
            vykreslit();
        }

        function potvrditVseVCase(cas, ids) {
            ids.forEach(id => potvrdit(id, cas));
        }

        function aktualizovatHistorii() {
            const n = new Date();
            const dJmeno = ["Ne", "Po", "Út", "St", "Čt", "Pá", "So"][n.getDay()];
            const dCislo = n.getDate();
            let dnesniZaznamy = [];
            leky.forEach(l => {
                let ok = (!l.rezim && l.dny.length === 0) || (l.dny.includes(dJmeno)) || 
                         (l.rezim === 'liche' && dCislo % 2 !== 0) || (l.rezim === 'sude' && dCislo % 2 === 0);
                if (ok) l.casy.forEach(c => { dnesniZaznamy.push({ nazev: l.nazev, cas: c, vzano: vzato[l.id + "_" + c] || false }); });
            });
            dnesniZaznamy.sort((a, b) => a.cas.localeCompare(b.cas));
            let index = historie.findIndex(h => h.datum === todayKey);
            if (index !== -1) historie[index].data = dnesniZaznamy; else historie.unshift({ datum: todayKey, data: dnesniZaznamy });
            if(historie.length > 7) historie.pop();
            localStorage.setItem('Lekovka_Hist_V6', JSON.stringify(historie));
        }

        function vykreslitHistorii() {
            aktualizovatHistorii();
            let html = historie.map(h => `
                <div class="hist-den ${h.datum === todayKey ? 'border-l-2 border-amber-500 pl-3' : 'opacity-60'}">
                    <div class="text-[10px] font-bold uppercase mb-2 ${h.datum === todayKey ? 'text-amber-500' : 'text-slate-500'}">${h.datum}</div>
                    ${h.data.map(d => `
                        <div class="flex justify-between items-center text-xs mb-1">
                            <span>${d.cas} - ${d.nazev}</span>
                            <span class="iconify ${d.vzano ? 'text-emerald-500' : 'text-red-500'}" data-icon="${d.vzano ? 'lucide:check-circle' : 'lucide:x-circle'}"></span>
                        </div>
                    `).join('')}
                </div>`).join('');
            document.getElementById('seznam-historie').innerHTML = html || '<div class="text-center opacity-30 py-10 italic">Žádná historie</div>';
        }

        function promazatHistorii() {
            if(confirm("Opravdu smazat historii?")) {
                historie = []; vzato = {};
                localStorage.setItem('Lekovka_Hist_V6', JSON.stringify(historie));
                localStorage.setItem('Lekovka_Vzato_V6', JSON.stringify(vzato));
                vykreslitHistorii(); vykreslit();
            }
        }

        function setI(el, val) { document.querySelectorAll('.i-chip').forEach(c => c.classList.remove('chip-active')); el.classList.add('chip-active'); tmpIkona = val; }
        function addT() { let v = document.getElementById('f-cas').value; if(v && !tmpCasy.includes(v)) { tmpCasy.push(v); tmpCasy.sort(); renderTmpT(); } }
        function renderTmpT() { document.getElementById('f-seznam-casu').innerHTML = tmpCasy.map(t => `<span onclick="removeT('${t}')" class="bg-amber-500/20 text-amber-500 px-2 py-1 rounded text-[10px] font-bold cursor-pointer">${t} ×</span>`).join(' '); }
        function removeT(t) { tmpCasy = tmpCasy.filter(x => x !== t); renderTmpT(); }
        function toggleD(el) { document.querySelectorAll('.r-chip').forEach(r => r.classList.remove('chip-active')); el.classList.toggle('chip-active'); }
        function toggleR(el) { let uzAktivni = el.classList.contains('chip-active'); document.querySelectorAll('.d-chip, .r-chip').forEach(c => c.classList.remove('chip-active')); if(!uzAktivni) el.classList.add('chip-active'); }

        function resetForm() { 
            document.getElementById('f-id').value = ''; document.getElementById('f-nazev').value = ''; 
            document.getElementById('f-sklad').value = '0'; document.getElementById('f-davka').value = '1'; 
            document.getElementById('edit-title').innerText = "Nový lék"; document.getElementById('btn-save').innerText = "Uložit lék"; 
            document.getElementById('btn-cancel').classList.add('hidden'); tmpCasy = []; renderTmpT(); 
            document.querySelectorAll('.chip-active').forEach(c => c.classList.remove('chip-active'));
            tmpIkona = 'pill';
        }

        function ulozit() { 
            let n = document.getElementById('f-nazev').value; let editId = document.getElementById('f-id').value; 
            if(!n || tmpCasy.length === 0) return alert("Zadejte název a čas!"); 
            let data = { 
                id: editId ? parseInt(editId) : Date.now(), ikona: tmpIkona, nazev: n, 
                sklad: parseFloat(document.getElementById('f-sklad').value) || 0, 
                davka: parseFloat(document.getElementById('f-davka').value) || 1, 
                casy: [...tmpCasy], dny: Array.from(document.querySelectorAll('.d-chip.chip-active')).map(d => d.innerText), 
                rezim: document.querySelector('.r-chip.chip-active')?.dataset.val || '' 
            }; 
            if(editId) { let idx = leky.findIndex(x => x.id === parseInt(editId)); leky[idx] = data; } else { leky.push(data); } 
            localStorage.setItem('Lekovka_V6', JSON.stringify(leky)); 
            resetForm(); nav('list'); 
        }

        function buildCard(l, casDnes = null) { 
            let denniPocet = l.casy.length; 
            let pocetDavek = denniPocet > 0 ? (l.sklad / (l.davka * denniPocet)) : 0; 
            let kriticky = pocetDavek <= 2; 
            let jeVzato = casDnes ? vzato[l.id + "_" + casDnes] : false; 
            let planText = l.rezim ? 'Obden ' + (l.rezim === 'sude' ? 'sudé' : 'liché') : (l.dny.length > 0 ? l.dny.join(', ') : 'Každý den'); 
            return `
                <div class="lek-karta ${kriticky ? 'critical-border' : 'normal-border'} ${jeVzato ? 'vzano' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <span class="iconify text-3xl text-amber-500" data-icon="lucide:${l.ikona}"></span>
                            <div>
                                <div class="font-bold text-lg leading-tight">${l.nazev}</div>
                                <div class="flex gap-1 mt-1">
                                    <span class="badge-info ${pocetDavek <= 2 ? 'text-red-500 font-bold border-red-500/50' : ''}">Sklad: ${l.sklad}</span>
                                    <span class="badge-info text-amber-500">Dávka: ${l.davka}</span>
                                </div>
                            </div>
                        </div>
                        ${!casDnes ? `<div class="flex gap-2"><button onclick="editovatLek(${l.id})" class="text-amber-500/40 p-1"><span class="iconify text-xl" data-icon="lucide:edit-3"></span></button>
                        <button onclick="smazat(${l.id})" class="text-red-500/20 p-1"><span class="iconify text-xl" data-icon="lucide:trash-2"></span></button></div>` : ''}
                    </div>
                    <div class="mt-3 text-[10px] space-y-1 bg-black/20 p-2 rounded-lg border border-white/5">
                        <div class="flex justify-between"><span class="text-slate-500 uppercase">Plán:</span><span class="text-slate-300 font-bold">${planText}</span></div>
                        <div class="flex justify-between"><span class="text-slate-500 uppercase">Výdrž:</span><span class="${kriticky ? 'text-red-500' : 'text-emerald-500'} font-black">cca ${Math.floor(pocetDavek)} dní</span></div>
                    </div>
                    ${casDnes ? (jeVzato ? `<div class="text-center py-2 text-emerald-500 font-black text-xs uppercase mt-2">Užito ✓</div>` : `<button onclick="potvrdit(${l.id},'${casDnes}')" class="btn-take">Potvrdit ${casDnes}</button>`) : ''}
                </div>`; 
        }

        function editovatLek(id) { 
            let l = leky.find(x => x.id === id); resetForm(); nav('add'); 
            document.getElementById('f-id').value = l.id; document.getElementById('f-nazev').value = l.nazev; 
            document.getElementById('f-sklad').value = l.sklad; document.getElementById('f-davka').value = l.davka; 
            tmpCasy = [...l.casy]; renderTmpT(); document.getElementById('edit-title').innerText = "Editace"; 
            document.getElementById('btn-save').innerText = "Aktualizovat"; document.getElementById('btn-cancel').classList.remove('hidden'); 
            tmpIkona = l.ikona; 
            document.querySelectorAll('.i-chip').forEach(c => { if(c.querySelector('.iconify').dataset.icon === 'lucide:'+l.ikona) c.classList.add('chip-active'); });
            document.querySelectorAll('.d-chip').forEach(c => { if(l.dny.includes(c.innerText)) c.classList.add('chip-active'); });
            if(l.rezim) { document.querySelectorAll('.r-chip').forEach(c => { if(c.dataset.val === l.rezim) c.classList.add('chip-active'); }); }
        }

        function smazat(id) { if(confirm("Smazat lék?")) { leky = leky.filter(l => l.id !== id); localStorage.setItem('Lekovka_V6', JSON.stringify(leky)); vykreslit(); } }

        function vykreslit() { 
            const n = new Date(); const dJmeno = ["Ne", "Po", "Út", "St", "Čt", "Pá", "So"][n.getDay()]; const dCislo = n.getDate();
            document.getElementById('today-date').innerText = dJmeno + " " + n.toLocaleDateString(); 
            document.getElementById('seznam-vse').innerHTML = leky.map(l => buildCard(l)).join('') || '<div class="opacity-20 py-10 italic text-center text-xs">Prázdno</div>'; 
            let groups = {}; 
            leky.forEach(l => { 
                let ok = (!l.rezim && l.dny.length === 0) || (l.dny.includes(dJmeno)) || (l.rezim === 'liche' && dCislo % 2 !== 0) || (l.rezim === 'sude' && dCislo % 2 === 0); 
                if(ok) l.casy.forEach(c => { if(!groups[c]) groups[c] = []; groups[c].push(l); }); 
            }); 
            let dnesHtml = ""; 
            Object.keys(groups).sort().forEach(cas => { 
                let ids = groups[cas].filter(l => !vzato[l.id + "_" + cas]).map(l => l.id); 
                dnesHtml += `<div class="mb-8"><div class="flex justify-between items-center border-b border-slate-700 pb-2 mb-4">
                <h3 class="text-xl font-black text-white flex items-center gap-2"><span class="iconify text-amber-500" data-icon="lucide:clock"></span> ${cas}</h3>
                ${ids.length > 0 ? `<button onclick="potvrditVseVCase('${cas}', [${ids.join(',')}])" class="btn-bulk">Vše</button>` : ''}</div>
                <div class="grid gap-2">${groups[cas].map(l => buildCard(l, cas)).join('')}</div></div>`; 
            }); 
            document.getElementById('seznam-dnes').innerHTML = dnesHtml || '<div class="opacity-20 py-10 italic text-center text-xs">Dnes nic</div>'; 
        }

        function exportToICS() {
            if (!leky || leky.length === 0) return alert("Nemáš žádné léky k exportu.");
            
            let icsContent = [
                "BEGIN:VCALENDAR",
                "VERSION:2.0",
                "PRODID:-//MojeLekovka//CS",
                "CALSCALE:GREGORIAN",
                "METHOD:PUBLISH"
            ].join("\r\n") + "\r\n";

            leky.forEach(l => {
                l.casy.forEach(cas => {
                    const [h, m] = cas.split(':');
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const stamp = year + month + day + "T" + h.padStart(2, '0') + m.padStart(2, '0') + "00";

                    icsContent += [
                        "BEGIN:VEVENT",
                        `UID:${Date.now()}-${l.id}@mojelekovka.local`,
                        `DTSTAMP:${stamp}`,
                        `DTSTART:${stamp}`,
                        `SUMMARY:Užít lék: ${l.nazev}`,
                        `DESCRIPTION:Dávka: ${l.davka}ks. Skladem: ${l.sklad}ks.`,
                        "RRULE:FREQ=DAILY",
                        "BEGIN:VALARM",
                        "TRIGGER:-PT0M",
                        "ACTION:DISPLAY",
                        `DESCRIPTION:Čas na lék: ${l.nazev}`,
                        "END:VALARM",
                        "END:VEVENT"
                    ].join("\r\n") + "\r\n";
                });
            });

            icsContent += "END:VCALENDAR";

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'lekovka_kalendar.ics');
            document.body.appendChild(link);
            link.click();
            
            setTimeout(() => {
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            }, 200);
        }

        function exportDat() { console.log(JSON.stringify({leky, historie})); alert("Data v konzoli (F12)."); }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW selhal:', err));
            });
        }
        nav('today');
    </script>
</body>
</html>
